<?php
session_start();
require_once 'includes/db_connect.php';

// р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕Яр╕ер╣Мр╣Вр╕Фр╕вр╕Хр╕гр╕З р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕гр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Ър╕Ъ POST р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: forgot_password.php');
    exit();
}

$username = trim($_POST['username']);

// р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╣Йр╕Щр╕лр╕▓р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Ир╕▓р╕Б username
$stmt = $pdo->prepare("SELECT id FROM users WHERE username = ?");
$stmt->execute([$username]);
$user = $stmt->fetch();

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕Щр╕гр╕░р╕Ър╕Ър╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if ($user) {
    // 1. р╕кр╕гр╣Йр╕▓р╕З Token р╕Чр╕╡р╣Ир╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕вр╣Бр╕ер╕░р╕Др╕▓р╕Фр╣Ар╕Фр╕▓р╣Др╕Фр╣Йр╕вр╕▓р╕Б
    // random_bytes р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ър╕Щр╕▓р╕гр╕╡р╣Бр╕Ър╕Ър╕кр╕╕р╣Ир╕б, bin2hex р╣Бр╕Ыр╕ер╕Зр╣Ар╕Ыр╣Зр╕Щр╕кр╕Хр╕гр╕┤р╕Зр╣Ар╕ер╕Вр╕Рр╕▓р╕Щ 16
    $token = bin2hex(random_bytes(32));

    // 2. Hash Token р╕Бр╣Ир╕нр╕Щр╣Ар╕Бр╣Зр╕Ър╕ер╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕вр╕кр╕╣р╕Зр╕кр╕╕р╕Ф
    // р╕лр╕▓р╕Бр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▒р╣Ир╕зр╣Др╕лр╕е Token р╕Ир╕гр╕┤р╕Зр╕Бр╣Зр╕Ир╕░р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╣Ар╕Ыр╕┤р╕Фр╣Ар╕Ьр╕в
    $token_hash = hash('sha256', $token);

    // 3. р╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕зр╕ер╕▓р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╕Вр╕нр╕З Token (р╣Ар╕Кр╣Ир╕Щ 15 р╕Щр╕▓р╕Чр╕╡р╕Ир╕▓р╕Бр╕Щр╕╡р╣Й)
    $expires_at = date('Y-m-d H:i:s', strtotime('+15 minutes'));

    // 4. р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б Token (р╕Чр╕╡р╣И hash р╣Бр╕ер╣Йр╕з) р╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕р╕ер╕Зр╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
    $stmt_update = $pdo->prepare(
        "UPDATE users SET reset_token = ?, reset_token_expires_at = ? WHERE id = ?"
    );
    $stmt_update->execute([$token_hash, $expires_at, $user['id']]);

    // 5. р╕кр╕гр╣Йр╕▓р╕Зр╕ер╕┤р╕Зр╕Бр╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ (р╕кр╣Ир╕З Token р╕Хр╕▒р╕зр╕Ир╕гр╕┤р╕З р╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕Хр╕▒р╕зр╕Чр╕╡р╣И hash)
    // р╣Гр╕Щр╕гр╕░р╕Ър╕Ър╕Ир╕гр╕┤р╕З р╕кр╣Ир╕зр╕Щр╕Щр╕╡р╣Йр╕Ир╕░р╣Гр╕Кр╣Йр╕кр╣Ир╕Зр╕нр╕╡р╣Ар╕бр╕е р╣Бр╕Хр╣Ир╣Гр╕Щ XAMPP р╣Ар╕гр╕▓р╕Ир╕░р╕Ир╕│р╕ер╕нр╕Зр╣Вр╕Фр╕вр╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕ер╕┤р╕Зр╕Бр╣Мр╕Вр╕╢р╣Йр╕Щр╕бр╕▓
    $reset_link = "http://localhost/voting_app/reset_password.php?token=" . $token;

    // р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╣Гр╕Щр╕лр╕Щр╣Йр╕▓ forgot_password.php
    $_SESSION['message_type'] = "success";
    $_SESSION['message'] = "р╕лр╕▓р╕Бр╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Щр╕╡р╣Йр╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕гр╕░р╕Ър╕Ъ р╕ер╕┤р╕Зр╕Бр╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щр╣Бр╕ер╣Йр╕з (р╕ер╕┤р╕Зр╕Бр╣Мр╕бр╕╡р╕нр╕▓р╕вр╕╕ 15 р╕Щр╕▓р╕Чр╕╡) <br><br><strong>ЁЯФЧ р╕ер╕┤р╕Зр╕Бр╣Мр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ъ:</strong> <a href='{$reset_link}' class='alert-link'>р╕Др╕ер╕┤р╕Бр╕Чр╕╡р╣Ир╕Щр╕╡р╣Ир╣Ар╕Юр╕╖р╣Ир╕нр╕Хр╕▒р╣Йр╕Зр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Гр╕лр╕бр╣И</a>";
    
} else {
    // р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в р╣Ар╕гр╕▓р╕Др╕зр╕гр╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щр╣Ар╕кр╕бр╕н р╣Др╕бр╣Ир╕зр╣Ир╕▓р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Ир╕░р╕бр╕╡р╕нр╕вр╕╣р╣Ир╕Ир╕гр╕┤р╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
    // р╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Бр╕▓р╕гр╣Ар╕Фр╕▓р╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ (User Enumeration Attack)
    $_SESSION['message_type'] = "info";
    $_SESSION['message'] = "р╕лр╕▓р╕Бр╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Щр╕╡р╣Йр╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Гр╕Щр╕гр╕░р╕Ър╕Ъ р╣Ар╕гр╕▓р╣Др╕Фр╣Йр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╕▓р╕бр╕Др╕│р╕Вр╕нр╕Вр╕нр╕Зр╕Чр╣Ир╕▓р╕Щр╣Бр╕ер╣Йр╕з р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕ер╕┤р╕Зр╕Бр╣М (р╕Чр╕╡р╣Ир╕Др╕зр╕гр╕Ир╕░р╕кр╣Ир╕Зр╣Др╕Ыр╕Чр╕▓р╕Зр╕нр╕╡р╣Ар╕бр╕е)";
}

// р╕кр╣Ир╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕Чр╕╡р╣Ир╕лр╕Щр╣Йр╕▓ forgot_password.php р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
header('Location: forgot_password.php');
exit();
?>